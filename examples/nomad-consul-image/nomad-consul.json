{
    "min_packer_version": "1.0.4",
    "variables": {
        "project_id": "courseur-1234",
        "zone": "europe-west4-a",
        "nomad_version": "0.8.3",
        "consul_module_version": "v0.0.1",
        "consul_version": "0.9.3"
    },
    "builders": [{
        "type": "googlecompute",
        "image_name": "nomad-consul-{{isotime \"2018-05-05-030405\"}}",
        "image_family": "nomad-consul",
        "project_id": "{{user `project_id`}}",
        "source_image_family": "ubuntu-1604-lts",
        "zone": "{{user `zone`}}",
        "ssh_username": "ubuntu"
    }],
    "provisioners": [{
        "type": "file",
        "source": "{{template_dir}}/../../../terraform-google-nomad",
        "destination": "/tmp",
        "pause_before": "30s"
    },{
        "type": "shell",
        "inline": [
            "/tmp/terraform-google-nomad/modules/install-nomad/install-nomad --version {{user `nomad_version`}}"
        ]
    },{
        "type": "shell",
        "inline": [
            "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -",
            "sudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"",
            "sudo apt-get update",
            "sudo apt-get install -y docker-ce",
            "sudo apt-get install -y git"
        ]
    },{
        "type": "shell",
        "inline": [
            "git clone --branch {{user `consul_module_version`}} https://github.com/hashicorp/terraform-google-consul.git /tmp/terraform-google-consul",
            "/tmp/terraform-google-consul/modules/install-consul/install-consul --version {{user `consul_version`}}"
        ]
    }]
}
